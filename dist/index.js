var f=(e,t,o)=>new Promise((n,r)=>{var s=l=>{try{c(o.next(l))}catch(d){r(d)}},a=l=>{try{c(o.throw(l))}catch(d){r(d)}},c=l=>l.done?n(l.value):Promise.resolve(l.value).then(s,a);c((o=o.apply(e,t)).next())});var i=e=>{let t=e.getAttribute("phx-target");if(!t)throw new Error('Target element does not have a "phx-target" attribute');return t};var m=e=>{var t;return"dataset"in e&&e.dataset.cellId?e:"dataset"in e&&"block"in e.dataset?e.querySelector("[data-cell-id]"):(t=e.parentElement)!=null&&t.dataset.cellId?e.parentElement:null},E=e=>{var t;return Array.prototype.indexOf.call(((t=e.parentNode)==null?void 0:t.children)||[],e)},b=()=>{let e=document.getSelection();if(!e)return!1;let t=e.anchorNode;if(!t)return!1;let o=t.nodeType===Node.TEXT_NODE?t.parentNode:t;return o?E(o)===0&&e.anchorOffset==0:!1},u=()=>{let e=document.getSelection();if(!e||!e.anchorNode||!e.focusNode)return;let t=m(e.anchorNode),o=m(e.focusNode);if(!t||!o)return null;let n=t.dataset.cellId,r=o.dataset.cellId,[s,a]=e.anchorOffset<e.focusOffset?[e.anchorOffset,e.focusOffset]:[e.focusOffset,e.anchorOffset];return{start_id:n,start_offset:s,end_id:r,end_offset:a}},v=e=>Array.from(e.children).map(o=>{let n=[];return o.tagName==="strong"&&n.push("strong"),o.tagName==="em"&&n.push("italic"),{id:o.dataset.cellId||"",text:o.innerText.replace("\xA0"," "),modifiers:n}}),T=e=>{if(e.key==="Backspace"&&b())return"backspace_from_start";if(e.shiftKey&&e.key==="Enter")return"split_line";if(e.key==="Enter")return"split_block";if(e.metaKey&&e.key==="b")return"toggle.bold";if(e.metaKey&&e.key==="i")return"toggle.italic"},p=e=>{let{selectionStartId:t,selectionEndId:o,selectionStartOffset:n,selectionEndOffset:r}=e.dataset;if(!t||!o||!n||!r)return;e.focus();let s=e.ownerDocument.getSelection();if(!s)return;s.removeAllRanges();let a=document.createRange(),c=e.querySelector(`[data-cell-id="${t}"]`);if(!c)return;let l=parseInt(n);c.childNodes[0]||c.appendChild(document.createTextNode("")),a.setStart(c.childNodes[0],l);let d=e.querySelector(`[data-cell-id="${o}"]`);if(!d)return;let y=parseInt(r);a.setEnd(d.childNodes[0],y),s.addRange(a)},S={mounted(){let e=this.el,t=null,o=null;e.addEventListener("input",()=>{t&&clearTimeout(t);let n="update",r=i(this.el);o=new Promise(s=>{let a=v(e),l={selection:u(),cells:a};t=window.setTimeout(()=>f(this,null,function*(){this.pushEventTo(r,n,l,()=>{t=null,o=null,s()})}),300)})}),e.addEventListener("keydown",n=>f(this,null,function*(){let r=T(n);if(!r)return;n.preventDefault();let s=u();o&&r&&(yield o),this.pushEventTo(i(e),r,{selection:s})})),e.addEventListener("paste",n=>{n.preventDefault();let r=i(e);this.pushEventTo(r,"paste_blocks",{selection:u()})}),p(e)},updated(){p(this.el)}};var k={mounted(){document.addEventListener("keydown",e=>{if(e.key==="z"&&e.metaKey&&e.shiftKey){this.pushEventTo(i(this.el),"redo"),e.preventDefault();return}if(e.key==="z"&&e.metaKey){this.pushEventTo(i(this.el),"undo"),e.preventDefault();return}e.key==="y"&&e.metaKey&&(this.pushEventTo(i(this.el),"redo"),e.preventDefault())})}};var x=(e,t)=>{let o=e.getBoundingClientRect(),n=t.getBoundingClientRect();return!(o.top>n.bottom||o.right<n.left||o.bottom<n.top||o.left>n.right)},H=e=>{document.addEventListener("copy",t=>{let o=document.querySelectorAll(".philtre__editor [data-selected]");o.length!==0&&(t.preventDefault(),e.pushEventTo(i(e.el),"copy_blocks",{block_ids:Array.from(o).map(n=>n.id)}))})},L=e=>Math.abs(e.toX-e.fromX),M=e=>Math.abs(e.toY-e.fromY),h=e=>Math.min(e.fromX,e.toX),g=e=>Math.min(e.fromY,e.toY),w=e=>{e.style.display="none",e.style.background="rgba(0,0,255,0.1)",e.style.position="fixed",e.style.display="block"},N=(e,t)=>{e.style.left=`${h(t)}px`,e.style.top=`${g(t)}px`,e.style.width=`${L(t)}px`,e.style.height=`${M(t)}px`},O=(e,t)=>{e.style.left=`${h(t)}px`,e.style.top=`${g(t)}px`,e.style.width="0px",e.style.height="0px"},_=e=>{e.style.display="none"},C={mounted(){H(this);let e=this.el,t={fromX:0,fromY:0,toX:0,toY:0,selecting:!1};document.addEventListener("mousedown",o=>{o.button===0&&(t.selecting=!0,t.fromX=o.x,t.fromY=o.y,w(e))}),document.addEventListener("mousemove",o=>{!t.selecting||(t.toX=o.x,t.toY=o.y,N(e,t))}),document.addEventListener("mouseup",()=>{t.selecting=!1;let o=document.querySelectorAll("[data-block]"),r={block_ids:Array.from(o).filter(s=>x(s,e)).map(s=>s.id)};O(e,t),_(e),this.pushEventTo(i(this.el),"select_blocks",r)})}};export{S as ContentEditable,k as History,C as Selection};
//# sourceMappingURL=index.js.map
